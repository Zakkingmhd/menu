<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0">
<title>Menu</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Plus Jakarta Sans', sans-serif; background: #FAFAFA; -webkit-tap-highlight-color: transparent; }
  .hide-scroll::-webkit-scrollbar { display: none; }
  .anim-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
  @keyframes slideUp { from { transform: translate(0, 100%); } to { transform: translate(0, 0); } }
  .active-cat { background-color: #0f172a; color: white; border-color: #0f172a; }
</style>
</head>
<body class="pb-32">

  <div class="bg-white/90 backdrop-blur-md border-b border-slate-100 sticky top-0 z-40">
    <div class="px-5 py-3 flex justify-between items-center">
      <button onclick="history.back()" class="text-slate-500 font-bold text-sm flex items-center gap-1 py-2 pr-4">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg>
        Back
      </button>
      <h1 id="rname" class="text-lg font-extrabold text-slate-900 truncate max-w-[200px]">Menu</h1>
      <div class="w-8"></div> </div>
    
    <div id="cat-container" class="flex gap-2 overflow-x-auto px-5 pb-3 hide-scroll"></div>
  </div>

  <div id="menu-sections" class="px-4 mt-6 space-y-8 min-h-[60vh]">
    <div class="text-center py-20 text-slate-400">Loading Menu...</div>
  </div>

  <div id="footer-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 p-4 pb-8 z-50 shadow-[0_-5px_20px_-5px_rgba(0,0,0,0.05)]">
    <div id="btn-contact" class="hidden">
      <button onclick="contactResto()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl active:scale-[0.98] transition-transform flex justify-center items-center gap-2">
        <span>Contact Restaurant</span>
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
      </button>
    </div>

    <div id="btn-checkout" class="hidden flex justify-between items-center bg-slate-900 text-white p-4 rounded-xl cursor-pointer active:scale-[0.98] transition-transform" onclick="openCart()">
      <div class="flex items-center gap-3">
        <div class="bg-white/20 w-10 h-10 rounded-lg flex items-center justify-center font-bold" id="total-qty">0</div>
        <div>
          <p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Total</p>
          <p class="text-lg font-bold leading-none">₹<span id="total-price">0</span></p>
        </div>
      </div>
      <div class="font-bold text-sm bg-blue-600 px-4 py-2 rounded-lg">View Order</div>
    </div>
  </div>

  <div id="modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[60] hidden">
    <div class="fixed bottom-0 w-full bg-white rounded-t-[32px] p-6 pb-8 anim-up shadow-2xl">
      <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6" onclick="closeCart()"></div>
      <h3 class="text-xl font-extrabold text-slate-900 mb-6">Your Order</h3>
      <div id="cartItems" class="space-y-4 mb-6 max-h-[40vh] overflow-y-auto"></div>
      <button onclick="checkout()" class="w-full bg-[#25D366] text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-[0.98] transition-transform">
        Send Order on WhatsApp
      </button>
    </div>
  </div>

<script>
// --- CONFIG ---
const EAZEO_WHATSAPP = "919744103674"; // Replace with your number
let cart = {}; // Structure: { "DishName_Variant": { name, variant, price, qty } }
let resto = {};

// --- INIT ---
const rid = new URLSearchParams(location.search).get("rid");

fetch("restaurants.json").then(r=>r.json()).then(rs => {
  resto = rs.find(r => r.id == rid);
  if(!resto) return;
  document.getElementById("rname").innerText = resto.name;
  
  // Show "Contact" button by default initially
  updateFooter();

  fetch(`https://opensheet.elk.sh/${resto.sheetId}/menu`)
    .then(x=>x.json())
    .then(data => renderMenu(data.filter(i => i.Status === "Available")));
});

function renderMenu(menuData) {
  const cats = [...new Set(menuData.map(i => i.Category || "General"))];
  const nav = document.getElementById("cat-container");
  const main = document.getElementById("menu-sections");
  
  main.innerHTML = "";

  cats.forEach((cat, idx) => {
    // Nav Pill
    nav.innerHTML += `<button onclick="document.getElementById('sec-${idx}').scrollIntoView({behavior:'smooth'})" class="px-4 py-2 rounded-full border border-slate-200 text-xs font-bold text-slate-500 whitespace-nowrap bg-white">${cat}</button>`;

    // Section
    let html = `<div id="sec-${idx}" class="scroll-mt-36"><h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 ml-1">${cat}</h3><div class="space-y-4">`;
    
    menuData.filter(i => (i.Category||"General") === cat).forEach(item => {
      // Find variants (columns like 'Price (Full)', 'Price (Half)')
      const variants = Object.keys(item).filter(k => k.includes("Price (")).map(k => k.match(/\((.*?)\)/)[1]);
      const safeVars = variants.length ? variants : (item["Price (Full)"] ? ['Full'] : ['Regular']);

      html += `
      <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
        <div class="flex justify-between gap-4 mb-4">
          <div><h4 class="font-bold text-slate-900 text-[17px]">${item.Item}</h4><p class="text-xs text-slate-400">Freshly prepared.</p></div>
          ${item.Image ? `<div class="w-16 h-16 rounded-xl bg-slate-100 bg-cover bg-center" style="background-image: url('${item.Image}')"></div>` : ''}
        </div>
        <div class="flex flex-wrap gap-2">
          ${safeVars.map(v => {
            const price = parseInt(String(item[`Price (${v})`] || 0).replace(/\D/g,''));
            const id = `${item.Item}_${v}`.replace(/\s+/g,''); // Safe ID
            return `
              <div id="btn-${id}" class="transition-all">
                <button onclick="addFirst('${item.Item}', '${v}', ${price}, '${id}')" class="border border-slate-200 bg-slate-50 px-4 py-2 rounded-lg text-xs font-bold text-slate-600 active:scale-95">
                  ${v} ₹${price}
                </button>
              </div>
            `;
          }).join('')}
        </div>
      </div>`;
    });
    main.innerHTML += html + `</div></div>`;
  });
}

// --- CART LOGIC ---

// 1. First Add (Turns Button into Counter)
function addFirst(name, variant, price, id) {
  const key = `${name}_${variant}`;
  cart[key] = { name, variant, price, qty: 1 };
  
  renderCounter(id, name, variant, price, 1);
  updateFooter();
}

// 2. Render the +/- Counter
function renderCounter(domId, name, variant, price, qty) {
  const container = document.getElementById(`btn-${domId}`);
  if(!container) return;

  if (qty === 0) {
    // Revert to simple button
    container.innerHTML = `<button onclick="addFirst('${name}', '${variant}', ${price}, '${domId}')" class="border border-slate-200 bg-slate-50 px-4 py-2 rounded-lg text-xs font-bold text-slate-600 active:scale-95">${variant} ₹${price}</button>`;
  } else {
    // Show Counter
    container.innerHTML = `
      <div class="flex items-center bg-slate-900 text-white rounded-lg px-1 py-1 shadow-lg shadow-blue-200/50">
        <button onclick="updateQty('${name}', '${variant}', ${price}, -1, '${domId}')" class="w-7 h-7 flex items-center justify-center font-bold text-lg active:scale-75 transition-transform">-</button>
        <span class="text-xs font-bold w-4 text-center">${qty}</span>
        <button onclick="updateQty('${name}', '${variant}', ${price}, 1, '${domId}')" class="w-7 h-7 flex items-center justify-center font-bold text-lg active:scale-75 transition-transform">+</button>
      </div>`;
  }
}

// 3. Update Quantity
function updateQty(name, variant, price, change, domId) {
  const key = `${name}_${variant}`;
  if (!cart[key]) return;

  cart[key].qty += change;

  if (cart[key].qty <= 0) {
    delete cart[key];
    renderCounter(domId, name, variant, price, 0);
  } else {
    renderCounter(domId, name, variant, price, cart[key].qty);
  }
  updateFooter();
}

// 4. Footer State Management
function updateFooter() {
  const count = Object.keys(cart).length;
  const contactBtn = document.getElementById("btn-contact");
  const checkoutBtn = document.getElementById("btn-checkout");

  if (count === 0) {
    contactBtn.classList.remove("hidden");
    checkoutBtn.classList.add("hidden");
  } else {
    contactBtn.classList.add("hidden");
    checkoutBtn.classList.remove("hidden");
    checkoutBtn.style.display = "flex"; // Force flex

    // Calc totals
    let totalQty = 0, totalPrice = 0;
    Object.values(cart).forEach(item => {
      totalQty += item.qty;
      totalPrice += (item.qty * item.price);
    });
    document.getElementById("total-qty").innerText = totalQty;
    document.getElementById("total-price").innerText = totalPrice;
  }
}

// --- CHECKOUT FLOWS ---

function contactResto() {
  const msg = `Hi, I have selected *${resto.name}* on Eazeo and would like to know more about the menu or place an order.`;
  window.open(`https://wa.me/${EAZEO_WHATSAPP}?text=${encodeURIComponent(msg)}`);
}

function openCart() {
  const modal = document.getElementById("modal");
  const list = document.getElementById("cartItems");
  list.innerHTML = "";
  
  Object.values(cart).forEach(item => {
    list.innerHTML += `
      <div class="flex justify-between items-center border-b border-slate-50 pb-3 last:border-0">
        <div>
          <p class="font-bold text-slate-900">${item.name}</p>
          <p class="text-xs text-slate-400">${item.variant} x ${item.qty}</p>
        </div>
        <p class="font-bold">₹${item.price * item.qty}</p>
      </div>`;
  });
  
  modal.classList.remove("hidden");
}

function closeCart() { document.getElementById("modal").classList.add("hidden"); }

function checkout() {
  let m = `*New Order: ${resto.name}*%0A%0A`;
  let total = 0;
  
  Object.values(cart).forEach(i => {
    const itemTotal = i.price * i.qty;
    total += itemTotal;
    m += `▪️ ${i.name} (${i.variant}) x ${i.qty} = ₹${itemTotal}%0A`;
  });
  
  m += `%0A*Total Payable: ₹${total}*`;
  window.open(`https://wa.me/${EAZEO_WHATSAPP}?text=${m}`);
}
</script>
</body>
</html>
