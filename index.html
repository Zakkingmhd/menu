<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0">
<title>Eazeo</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root { --primary: #0F172A; --accent: #2563EB; --bg: #F8FAFC; }
  body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); -webkit-tap-highlight-color: transparent; }
  .hide-scroll::-webkit-scrollbar { display: none; }
  .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
  .shimmer { background: linear-gradient(90deg, #f0f0f0 25%, #f8f8f8 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
</style>
</head>
<body class="pb-24 antialiased text-slate-900 selection:bg-blue-100 selection:text-blue-900">

  <!-- Header -->
  <div class="glass sticky top-0 z-50 px-6 py-4 flex justify-between items-center transition-all duration-300">
    <div class="w-28 h-8 flex items-center">
      <!-- LOGO INTEGRATION HERE -->
      <img src="logo.png" alt="Eazeo" class="h-full w-auto object-contain object-left">
    </div>
    <span id="zone-badge" class="hidden text-[10px] bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-full font-extrabold uppercase tracking-widest shadow-sm ring-1 ring-indigo-100">Zone Active</span>
  </div>

  <!-- Hero Section -->
  <div class="px-6 pt-8 pb-4">
    <h2 class="text-[32px] font-extrabold text-slate-900 leading-[1.1] tracking-tight mb-8">
      <span id="greeting" class="text-slate-400 font-semibold text-xl block mb-1">Hello,</span>
      What are you <br><span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">craving today?</span>
    </h2>
    
    <!-- Search Bar -->
    <div class="relative group transform transition-all duration-300 focus-within:-translate-y-1">
      <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none">
        <svg class="h-6 w-6 text-slate-400 group-focus-within:text-blue-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
      </div>
      <input id="q" type="text" placeholder="Search dishes (e.g., 'Porotta')" class="block w-full pl-14 pr-4 py-4 bg-white border-0 rounded-2xl text-lg font-medium text-slate-900 shadow-[0_8px_30px_rgb(0,0,0,0.04)] placeholder:text-slate-300 focus:ring-2 focus:ring-blue-500/20 focus:shadow-[0_8px_30px_rgb(37,99,235,0.1)] transition-all outline-none">
    </div>
  </div>

  <!-- Restaurant Feed -->
  <div id="resto-feed" class="px-6 mt-6">
    <div class="flex justify-between items-end mb-5">
      <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Nearby Favorites</h3>
      <span class="text-[10px] font-bold text-slate-400 bg-white border border-slate-100 px-2 py-1 rounded-md shadow-sm" id="r-count">Locating...</span>
    </div>
    
    <div id="resto-list" class="space-y-5">
      <!-- Skeleton Loader -->
      <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-50 flex items-center gap-4">
        <div class="w-14 h-14 rounded-full shimmer"></div>
        <div class="space-y-2 flex-1"><div class="h-4 w-32 shimmer rounded"></div><div class="h-3 w-20 shimmer rounded"></div></div>
      </div>
      <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-50 flex items-center gap-4">
        <div class="w-14 h-14 rounded-full shimmer"></div>
        <div class="space-y-2 flex-1"><div class="h-4 w-24 shimmer rounded"></div><div class="h-3 w-16 shimmer rounded"></div></div>
      </div>
    </div>
  </div>

  <!-- Search Results Feed -->
  <div id="search-feed" class="px-6 mt-6 hidden">
    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Search Results</h3>
    <div id="results" class="space-y-3"></div>
  </div>

  <script>
    // --- 0. WORLD CLASS UTILS ---
    const setGreeting = () => {
      const hr = new Date().getHours();
      const el = document.getElementById('greeting');
      if (hr < 12) el.innerText = "Good morning,";
      else if (hr < 18) el.innerText = "Good afternoon,";
      else el.innerText = "Good evening,";
    };
    setGreeting();

    // --- 1. CONFIG & PARSING ---
    let allItems = [];
    let loadedRestos = [];
    const urlParams = new URLSearchParams(window.location.search);
    const rawRestos = urlParams.get('restos');
    const allowedIds = rawRestos ? rawRestos.split(',').map(id => parseInt(id.trim())) : null;

    if(allowedIds) document.getElementById('zone-badge').classList.remove('hidden');

    // --- 2. ADVANCED FUZZY LOGIC (Levenshtein) ---
    function levenshtein(a, b) {
      const matrix = [];
      for(let i=0; i<=b.length; i++) matrix[i] = [i];
      for(let j=0; j<=a.length; j++) matrix[0][j] = j;

      for(let i=1; i<=b.length; i++) {
        for(let j=1; j<=a.length; j++) {
          if(b.charAt(i-1) == a.charAt(j-1)) {
            matrix[i][j] = matrix[i-1][j-1];
          } else {
            matrix[i][j] = Math.min(matrix[i-1][j-1] + 1, Math.min(matrix[i][j-1] + 1, matrix[i-1][j] + 1));
          }
        }
      }
      return matrix[b.length][a.length];
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // --- 3. FETCH & RENDER ---
    fetch("restaurants.json")
      .then(r => r.json())
      .then(async allData => {
        const targetRestos = allowedIds ? allData.filter(r => allowedIds.includes(r.id)) : allData;
        loadedRestos = shuffle([...targetRestos]);
        
        renderRestoList(loadedRestos);

        // Pre-fetch menus for instant search
        const promises = loadedRestos.map(r => 
          fetch(`https://opensheet.elk.sh/${r.sheetId}/menu`)
            .then(x => x.json())
            .then(data => {
              data.filter(i => i.Status === "Available").forEach(i => {
                allItems.push({ name: i.Item, resto: r.name, restoId: r.id });
              });
            })
            .catch(e => console.log("Skip", r.name))
        );
        await Promise.all(promises);
      });

    function renderRestoList(list) {
      const container = document.getElementById("resto-list");
      document.getElementById("r-count").innerText = `${list.length} Available`;
      
      const emojis = ['ðŸ•','ðŸœ','ðŸ”','ðŸ¥˜','ðŸ£','ðŸ°','ðŸ¥—'];
      
      container.innerHTML = list.map((r, i) => `
        <div onclick="location.href='resto.html?rid=${r.id}'" class="group bg-white p-5 rounded-3xl border border-slate-100 shadow-[0_2px_15px_-4px_rgba(0,0,0,0.05)] hover:shadow-[0_8px_30px_-4px_rgba(0,0,0,0.1)] transition-all duration-300 cursor-pointer active:scale-[0.98]">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-5">
              <div class="w-14 h-14 rounded-2xl bg-slate-50 flex items-center justify-center text-2xl shadow-inner group-hover:bg-blue-50 transition-colors">
                ${emojis[i % emojis.length]}
              </div>
              <div>
                <h4 class="font-bold text-slate-900 text-lg leading-tight group-hover:text-blue-600 transition-colors">${r.name}</h4>
                <p class="text-xs text-slate-400 font-semibold mt-1">Tap to view menu</p>
              </div>
            </div>
            <div class="bg-slate-50 p-2.5 rounded-full text-slate-300 group-hover:bg-blue-600 group-hover:text-white transition-all duration-300">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
            </div>
          </div>
        </div>
      `).join('');
    }

    // --- 4. SMART SEARCH ---
    document.getElementById("q").oninput = e => {
      const q = e.target.value.toLowerCase().trim();
      const rFeed = document.getElementById("resto-feed");
      const sFeed = document.getElementById("search-feed");
      const out = document.getElementById("results");

      if(!q) {
        rFeed.classList.remove("hidden");
        sFeed.classList.add("hidden");
        return;
      }

      rFeed.classList.add("hidden");
      sFeed.classList.remove("hidden");

      // Smart Filter: Includes + Fuzzy
      const res = allItems.filter(i => {
        const name = i.name.toLowerCase();
        if(name.includes(q)) return true;
        // Fuzzy logic: tolerant of 2 typos for inputs > 2 chars
        if(q.length > 2) {
            const words = name.split(' ');
            // Match if any word in the dish name is close to the query OR whole string matches
            return words.some(w => levenshtein(w, q) <= 2) || levenshtein(name, q) <= 3;
        }
        return false;
      });

      if(res.length === 0) {
        out.innerHTML = `
          <div class="flex flex-col items-center py-12 text-center opacity-50">
            <svg class="w-12 h-12 text-slate-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <p class="text-sm font-semibold text-slate-400">No cravings found.</p>
          </div>`;
        return;
      }

      out.innerHTML = res.slice(0, 15).map(i => `
        <div onclick="location.href='resto.html?rid=${i.restoId}'" class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex justify-between items-center active:scale-[0.99] transition-transform cursor-pointer hover:border-blue-200">
          <div>
            <h4 class="font-bold text-slate-800 text-[15px]">${i.name}</h4>
            <div class="flex items-center gap-2 mt-1.5">
              <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
              <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">${i.resto}</span>
            </div>
          </div>
          <svg class="text-slate-300" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg>
        </div>
      `).join('');
    };
  </script>
</body>
</html>
