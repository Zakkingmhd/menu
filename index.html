<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0">
<title>Eazeo | Food Court</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Plus Jakarta Sans', sans-serif; background: #F8FAFC; -webkit-tap-highlight-color: transparent; }
  .hide-scroll::-webkit-scrollbar { display: none; }
  .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); }
</style>
</head>
<body class="pb-24">

  <div class="glass sticky top-0 z-50 px-5 py-4 flex justify-between items-center border-b border-slate-100/50">
    <h1 class="text-2xl font-extrabold tracking-tight text-slate-900">Eazeo<span class="text-blue-600">.</span></h1>
    <span id="zone-badge" class="hidden text-[10px] bg-blue-50 text-blue-600 px-2.5 py-1 rounded-full font-bold uppercase tracking-wider">Zone Mode</span>
  </div>

  <div class="px-5 pt-6 pb-2">
    <h2 class="text-3xl font-extrabold text-slate-900 leading-tight mb-6">What are you <br><span class="text-blue-600">craving?</span></h2>
    <div class="relative group">
      <input id="q" type="text" placeholder="Search for dishes..." class="w-full p-4 pl-12 rounded-2xl border-none bg-white shadow-[0_4px_20px_-4px_rgba(0,0,0,0.05)] text-lg focus:ring-2 focus:ring-blue-500/20 transition-all outline-none text-slate-700 placeholder:text-slate-400">
      <div class="absolute left-4 top-4 text-slate-400">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
      </div>
    </div>
  </div>

  <div id="resto-feed" class="px-5 mt-8">
    <div class="flex justify-between items-end mb-4">
      <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest">Restaurants</h3>
      <span class="text-xs font-medium text-slate-400 bg-slate-100 px-2 py-1 rounded-lg" id="r-count">Loading...</span>
    </div>
    <div id="resto-list" class="space-y-4"></div>
  </div>

  <div id="search-feed" class="px-5 mt-6 hidden">
    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Matching Dishes</h3>
    <div id="results" class="space-y-3"></div>
  </div>

  <script>
    let allItems = [];
    let loadedRestos = [];

    // --- 1. CONFIG & PARSING ---
    const urlParams = new URLSearchParams(window.location.search);
    const rawRestos = urlParams.get('restos');
    const allowedIds = rawRestos ? rawRestos.split(',').map(id => parseInt(id.trim())) : null;

    if(allowedIds) document.getElementById('zone-badge').classList.remove('hidden');

    // --- 2. LOGIC ---
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // Standard Levenshtein Distance for fuzzy matching
    // Returns number of edits required to turn 'a' into 'b'
    function levenshtein(a, b) {
      const matrix = [];
      for(let i=0; i<=b.length; i++) matrix[i] = [i];
      for(let j=0; j<=a.length; j++) matrix[0][j] = j;

      for(let i=1; i<=b.length; i++) {
        for(let j=1; j<=a.length; j++) {
          if(b.charAt(i-1) == a.charAt(j-1)) {
            matrix[i][j] = matrix[i-1][j-1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i-1][j-1] + 1, // substitution
              Math.min(matrix[i][j-1] + 1, matrix[i-1][j] + 1) // insertion/deletion
            );
          }
        }
      }
      return matrix[b.length][a.length];
    }

    // --- 3. FETCH & RENDER ---
    fetch("restaurants.json")
      .then(r => r.json())
      .then(async allData => {
        const targetRestos = allowedIds ? allData.filter(r => allowedIds.includes(r.id)) : allData;
        loadedRestos = shuffle([...targetRestos]);
        
        renderRestoList(loadedRestos);

        const promises = loadedRestos.map(r => 
          fetch(`https://opensheet.elk.sh/${r.sheetId}/menu`)
            .then(x => x.json())
            .then(data => {
              data.filter(i => i.Status === "Available").forEach(i => {
                allItems.push({ name: i.Item, resto: r.name, restoId: r.id });
              });
            })
            .catch(e => console.log("Skip", r.name))
        );
        await Promise.all(promises);
      });

    function renderRestoList(list) {
      const container = document.getElementById("resto-list");
      document.getElementById("r-count").innerText = `${list.length} Nearby`;
      
      container.innerHTML = list.map((r, i) => `
        <div onclick="location.href='resto.html?rid=${r.id}'" class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between active:scale-[0.98] transition-transform cursor-pointer">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-100 to-indigo-100 flex items-center justify-center text-xl">
              ${['üçï','üçî','ü•ò','üç≤','üçõ'][i % 5]}
            </div>
            <div>
              <h4 class="font-bold text-slate-900 text-lg">${r.name}</h4>
              <p class="text-xs text-slate-400 font-medium mt-0.5">View Menu & Order</p>
            </div>
          </div>
          <div class="bg-slate-50 p-2 rounded-full text-slate-300">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
          </div>
        </div>
      `).join('');
    }

    // --- 4. SEARCH INTERACTION ---
    document.getElementById("q").oninput = e => {
      const q = e.target.value.toLowerCase().trim();
      const rFeed = document.getElementById("resto-feed");
      const sFeed = document.getElementById("search-feed");
      const out = document.getElementById("results");

      if(!q) {
        rFeed.classList.remove("hidden");
        sFeed.classList.add("hidden");
        return;
      }

      rFeed.classList.add("hidden");
      sFeed.classList.remove("hidden");

      // Filter Logic:
      // 1. Direct Include match
      // 2. Fuzzy match (Levenshtein distance < 3 for words > 3 chars)
      const res = allItems.filter(i => {
        const name = i.name.toLowerCase();
        if(name.includes(q)) return true;
        
        // Fuzzy check: allow 2 errors for input length > 3
        if(q.length > 2) {
          // Check against the whole name or individual words in the name
          const words = name.split(' ');
          const isFuzzyMatch = words.some(w => levenshtein(w, q) <= 2) || levenshtein(name, q) <= 3;
          return isFuzzyMatch;
        }
        return false;
      });

      if(res.length === 0) {
        out.innerHTML = '<div class="text-center py-10 text-slate-400 text-sm">No matching dishes found.</div>';
        return;
      }

      // Limit results to 20 for performance
      out.innerHTML = res.slice(0, 20).map(i => `
        <div onclick="location.href='resto.html?rid=${i.restoId}'" class="bg-white p-4 rounded-xl border border-slate-100 flex justify-between items-center active:bg-slate-50 cursor-pointer">
          <div>
            <h4 class="font-bold text-slate-800">${i.name}</h4>
            <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded mt-1 inline-block">${i.resto}</span>
          </div>
          <svg class="text-slate-300" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>
      `).join('');
    };
  </script>
</body>
</html>
